# שימחוקלוק – שרת ההמלצות להפצת שעונים

שרת Node.js שמספק שכבת API ונתונים לוגיסטיים עבור "שימחוקלוק", מנוע המלצות להפצת שעונים. המסמך מסכם את היכולות הקיימות כרגע ומסמן לאן המערכת צפויה להתפתח.

## מה יש היום
- **בריאות שירות**: `GET /health` מחזיר `{ ok: true }` לבדיקה מהירה שהשרת רץ.
- **דוחות לוגיסטיים**
  - `GET /api/logistics/daily` – מחזיר תצפית יומית מורחבת על מלאי וחוסרים; ניתן לסנן לפי `status` (`SAFE`/`CRITICAL`/`DEAD_STOCK`).
  - `GET /api/logistics/risk60d` – מזהה מוצרים שצפויים להיכנס לסיכון חוסר ב-60 הימים הבאים.
  - `GET /api/logistics/reorder` – המלצות הזמנה עם סדר עדיפויות לפי רמת סיכון ומצב.
- **ניהול חריגי ROP**
  - `POST /api/overrides` – יצירת Override ל-ROP/כמות הזמנה עם אפשרות לציון סיבה; מבטל Override פעיל קודם לאותו מוצר.
  - `PATCH /api/overrides/:id/disable` – השבתת Override קיים.
- **הזמנות רכש**
  - `GET /api/purchase-orders` – צפייה בהזמנות רכש אחרונות (עד 200 אחרונות).
  - `POST /api/purchase-orders` – פתיחת הזמנת רכש חדשה עם כמות נדרשת ותאריך הגעה משוער (אופציונלי).
- **עדכון מלאי**
  - `PATCH /api/inventory/:productId` – עדכון/הכנסת רמות מלאי (`onHand`, `reserved`, `inTransit`) עם upsert ושמירת זמני ספירה.

## ארכיטקטורה וקונפיגורציה
- **טכנולוגיה**: Express + TypeScript, חיבור ל-PostgreSQL דרך `pg`.
- **קובץ כניסה**: `src/server.ts` מריץ את היישום עם פורט מוגדר (`PORT`, ברירת מחדל 3000).
- **חיבור למסד**: משתנה סביבה חובה `DATABASE_URL` מוגדר בקובץ `.env` (טעינה באמצעות `dotenv`).
- **Middleware**: טיפול בשגיאות מרכזי שמחזיר 500 במקרי כשל בלתי צפויים.

### הרצה מקומית
1. התקנת תלויות: `npm install`.
2. יצירת קובץ `.env` עם `DATABASE_URL=postgres://...`.
3. פיתוח: `npm run dev` (ts-node-dev עם reload). הפקה: `npm run build` ואז `npm start`.

## מה צפוי להתווסף בהמשך
מבוסס על סיפורי המשתמש המלאים שהוגדרו:

- **מנהל מכירות**: הצעות מלאי ממוקדות לבעלי חנויות עם מגבלת תקציב (עד 15% מתקציב החנות), טיפול בחנויות חדשות דרך "הנמכרים ביותר", וסינון כפילויות (לא להציע פריטים שנקנו ב-30 הימים האחרונים).
- **מנהל שיווק**: דו"ח שבועי לזיהוי פער מותג (>30% פער ביחס לממוצע אזורי) עם נימוקים דמוגרפיים אוטומטיים ואפשרות לייצוא פרטי קשר לניהול קמפיינים.
- **מנהל לוגיסטיקה**: חיזוי חוסרי מלאי חכם עם מקדם עונתיות והתחשבות ב-lead time, התראות על מלאי מת (ירידה של 40–60% בקצב מכירה), ורשימת מוצרים בסיכון.
- **בעל חנות**: אזור אישי להצגת הצעת מלאי, אישור/דחייה ועריכת כמויות; חישוב סל דינמי בזמן אמת, איסוף סיבת דחייה מחייבת, ובדיקת מסגרת אשראי שמחסמת אישור חריג.

## ידועות ומגבלות נוכחיות
- אינו כולל עדיין ניהול זהויות/הרשאות, ממשק משתמש, או מנגנוני חישוב ההמלצות עצמם – ה-API מסתמך על נתונים שמגיעים ממסד PostgreSQL (למשל views ו-CTE קיימים).
- אין ואלידציה שכבת-דומיין מעבר לבדיקות שדות בסיסיות (למשל כמות הזמנה > 0).

